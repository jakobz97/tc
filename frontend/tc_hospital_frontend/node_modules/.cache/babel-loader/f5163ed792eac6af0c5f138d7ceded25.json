{"ast":null,"code":"import _objectSpread from\"/Users/Jakob/Desktop/TUM/Semester_01/inno_entre/tech_challenge/tc/frontend/tc_hospital_frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _toConsumableArray from\"/Users/Jakob/Desktop/TUM/Semester_01/inno_entre/tech_challenge/tc/frontend/tc_hospital_frontend/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _slicedToArray from\"/Users/Jakob/Desktop/TUM/Semester_01/inno_entre/tech_challenge/tc/frontend/tc_hospital_frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import React,{useEffect,useState}from\"react\";import'../../../styles/shared/editor/editor.css';import'../../../styles/shared/fadein.css';import{setUserData,selectUserData}from\"../../../slice/userSlice\";import{codeCompletionAsync,uploadStudentCodeAsync}from\"../../../slice/reviewSlice\";import{fromRange}from\"xpath-range\";import{v4 as uuidv4}from\"uuid\";import{useDispatch,useSelector}from\"react-redux\";import{history}from\"../../../helpers/history\";import{userData}from\"../../../services/user.service\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var Editor=function Editor(_ref){var close=_ref.close,taskData=_ref.taskData;var _useState=useState({}),_useState2=_slicedToArray(_useState,2),selTxt=_useState2[0],setSelTxt=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),tempCodes=_useState4[0],setTempCodes=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),loadedTxt=_useState6[0],setLoadedTxt=_useState6[1];var dispatch=useDispatch();var userData=useSelector(selectUserData);/**\n     * @function (01) get the dark background, the content wrapper and the inputs\n     *           (02) increase the dark background opacity\n     *           (03) fade up the content wrapper\n     *           =============\n     *           (04) insert the feature rich txt\n     *           (05) show the tooltip\n     *           (06) ensure that the code display has the same length as the overflow text\n     *           (07) ensure that the empty codes text is centered\n     */useEffect(function(){//01\nvar bg=document.querySelector('.menu_dark_bg'),content=document.querySelector('.create_input_wrapper');//02\nbg.style.cssText=\"opacity: 100%\";//03\ncontent.style.marginTop=\"0\";//04\ndocument.getElementsByClassName('code_input')[0].innerHTML=taskData.txt;//05\nsetLoadedTxt(true);//06\ndocument.getElementById('internal_code_display').style.height=document.getElementsByClassName('code_input')[0].scrollHeight+'px';//07\ndocument.getElementsByClassName('empty_editor')[0].style.height=document.getElementsByClassName('code_input')[0].offsetHeight+'px';},[]);/**\n     * @function (01) get the background and content\n     *           (02) return if user clicked on the content\n     *           (03) user clicked outside of content - hide\n     *           (04) after timeout set state again to hidden\n     */var hideCreateView=function hideCreateView(e,forced){//01\nvar bg=document.querySelector('.menu_dark_bg'),content=document.querySelector('.create_input_wrapper');//02\nif(!forced&&content.contains(e.target))return;//03\nbg.style.cssText=\"opacity: 0%\";content.style.marginTop=\"150vh\";//04\nsetTimeout(function(){return close();},350);};/**\n     * @function (01) define the target by choosing the complementary of the scrolled div\n     *           (02) assign scroll toü and scroll left to the target based on the event scrolled position\n     */var syncScroll=function syncScroll(e,origin){//01\nvar target=origin==='display'?document.getElementsByClassName('code_input')[0]:document.getElementsByClassName('code_display')[0];//02\ntarget.scrollTop=e.currentTarget.scrollTop;target.scrollLeft=e.currentTarget.scrollLeft;};//====================================================================\n/**\n     * @function (01) check that there is no overlapping regarding the codes\n     *           (02) highlight the code\n     *           (03) push into data structure (updates the code overview on the right side)\n     */var addCode=function addCode(){//01\nvar startOverlapCheck=tempCodes.filter(function(code){return selTxt.start>code.start&&selTxt.start<code.end;});var endOverlapCheck=tempCodes.filter(function(code){return selTxt.end<code.end&&selTxt.end>code.start;});if(startOverlapCheck.length>0||endOverlapCheck.length>0)return alert('No overlaps possbile');//02\nsetSelectionRange(selTxt.start,selTxt.end);//highlight(\"yellow\");\n//03\nsetTempCodes(function(currentCodes){return[].concat(_toConsumableArray(currentCodes),[selTxt]);});};/**\n     * @function (01) get all selects and positions\n     *           (02) if only cursor change takes place only hide the tooltip\n     *           (03) reposition tooltip\n     *           (04) set selected text state\n     */var selector=function selector(e){//01\nvar select=window.getSelection(),selectRange=select.getRangeAt(0),selectPos=selectRange.getBoundingClientRect(),codeInput=document.getElementsByClassName('code_input')[0],codeInputPos=codeInput.getBoundingClientRect(),tooltip=document.getElementById('tooltip_editor_wrapper');//02\nif(selectPos.width<1)return tooltip.style.display=\"none\";//03\ntooltip.style.display=\"inline\";tooltip.style.top=selectPos.top-codeInputPos.top-tooltip.offsetHeight-10+codeInput.scrollTop+'px';tooltip.style.left=selectPos.left-codeInputPos.left+selectPos.width/2-tooltip.offsetWidth/2+'px';//04\nvar xpath=fromRange(selectRange,codeInput);setSelTxt(_objectSpread(_objectSpread({},selTxt),{val:selectRange.toString(),start:xpath.startOffset,end:xpath.endOffset,top:selectPos.top-codeInputPos.top+codeInput.scrollTop-5,id:uuidv4()}));};/**\n     * @function (01)\n     *           (02)\n     * @param start\n     * @param end\n     */function setSelectionRange(start,end){var el=document.getElementsByClassName('code_input')[0];var range=document.createRange();range.selectNodeContents(el);var textNodes=getTextNodesIn(el);var foundStart=false;var charCount=0,endCharCount;for(var i=0,textNode;textNode=textNodes[i++];){endCharCount=charCount+textNode.length;if(!foundStart&&start>=charCount&&(start<endCharCount||start==endCharCount&&i<=textNodes.length)){range.setStart(textNode,start-charCount);foundStart=true;}if(foundStart&&end<=endCharCount){range.setEnd(textNode,end-charCount);break;}charCount=endCharCount;}var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);//Helper functions\nfunction getTextNodesIn(node){var textNodes=[];if(node.nodeType===3){textNodes.push(node);}else{var children=node.childNodes;for(var i=0,len=children.length;i<len;++i){textNodes.push.apply(textNodes,getTextNodesIn(children[i]));}}return textNodes;}}//====================================================================\n/**\n     * @function (00) wait until typing ended and dispatch send to backend for code completion and wait - if more than one is found throw error\n     *           (01) duplicate the array\n     *           (02) find the array entry by index\n     *           (03) add code to this entry\n     *           (04) add the description\n     *           (05) indicate that this code is ok -> remove any border color\n     * @param e is the event\n     * @param i is the index of the array element which is\n     * @param type either id or desc of the code - required for the autocompletion\n     */var typingTimerEdit;var editCode=function editCode(e,i,type){//00\nclearTimeout(typingTimerEdit);if(!e.target.value)return;typingTimerEdit=setTimeout(function(){dispatch(codeCompletionAsync({type:type,val:e.target.value})).then(function(res){if(res.payload.matches.length!==1){document.getElementsByClassName('ind_code_display')[i].style.border=\"1px solid red\";return document.getElementsByClassName('large_code_section')[i].value='Zu viele Ergebnisse - '+res.payload.matches.length;}//01\nvar newArr=_toConsumableArray(tempCodes);//02\nvar mergedObj=_objectSpread(_objectSpread({},newArr[i]),{},{icdCode:e.target.value,icdCodeDesc:res.payload.matches[0][2]});newArr[i]=mergedObj;//03\nsetTempCodes(newArr);//04\ndocument.getElementsByClassName('large_code_section')[i].value=res.payload.matches[0][2];//05\ndocument.getElementsByClassName('ind_code_display')[i].style.border=\"none\";}).catch(function(err){console.log(err);});},200);};/**\n     * @function (01) duplicate the array\n     *           (02) splice the array\n     *           (03) set the new temp codes\n     * @param i index of the highlight which is deleted\n     */var removeTxt=function removeTxt(i){var newArr=_toConsumableArray(tempCodes);//02\nnewArr.splice(i,1);//03\nsetTempCodes(newArr);};// ====================================================================\n/**\n     * @function (01) check if all temp codes were assigned - if not proceed and let user assign icd 10 code\n     *           (02) upload codes to backend and perform server side comparison\n     *           (03) once finished jump to the analytics page where detailed information can be obtained\n     */var uploadStudentCode=function uploadStudentCode(){//01\nvar nonFinishedCodes=tempCodes.filter(function(code,index){return!code.icdCode||code.icdCode===\"\";});if(nonFinishedCodes.length>0)return alert('not all codes were assigned');//02\ndispatch(uploadStudentCodeAsync(_objectSpread({tempCodes:tempCodes},{reviewId:taskData._id}))).then(function(res){//03\nhistory.push(\"/student/analytics/\");window.location.reload();}).catch(function(err){console.log('err',err);});};//====================================================================\nreturn/*#__PURE__*/_jsx(\"div\",{className:\"menu_dark_bg\",onClick:hideCreateView,children:/*#__PURE__*/_jsxs(\"div\",{className:\"create_input_wrapper enlarged_create_input_wrapper\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"create_input_hide\",onClick:function onClick(e){hideCreateView(e,true);},children:\"X\"}),/*#__PURE__*/_jsx(\"div\",{className:\"code_input enlarged_code_input\",onMouseUp:selector,onScroll:function onScroll(e){return syncScroll(e,'input');},children:loadedTxt&&/*#__PURE__*/_jsx(\"div\",{id:\"tooltip_editor_wrapper\",children:/*#__PURE__*/_jsx(\"div\",{className:\"tooltip_btn\",onClick:addCode,children:\"Code hinzuf\\xFCgen\"})})}),/*#__PURE__*/_jsxs(\"div\",{className:\"code_display enlarged_code_display\",onScroll:function onScroll(e){return syncScroll(e,'display');},children:[/*#__PURE__*/_jsx(\"div\",{id:\"internal_code_display\",children:tempCodes.length>0?tempCodes.map(function(code,i){return/*#__PURE__*/_jsxs(\"div\",{className:\"ind_code_display\",id:code.id,style:{top:code.top+'px'},children:[/*#__PURE__*/_jsx(\"input\",{placeholder:\"Code ID\",className:\"small_code_section\",onChange:function onChange(e){return editCode(e,i,'id');}}),/*#__PURE__*/_jsx(\"input\",{placeholder:\"Code Desc\",className:\"large_code_section\",readOnly:true}),/*#__PURE__*/_jsx(\"div\",{className:\"remove_code_btn\",onClick:function onClick(){return removeTxt(i);},children:\"X\"})]},i);}):/*#__PURE__*/_jsx(\"div\",{className:\"empty_editor\",children:\"Vergebe Codes\"})}),tempCodes.length>0&&/*#__PURE__*/_jsx(\"div\",{className:\"student_compare_btn\",onClick:function onClick(){return uploadStudentCode();},children:\"Codes hochladen und vergleichen\"})]})]})});};export default Editor;","map":{"version":3,"sources":["/Users/Jakob/Desktop/TUM/Semester_01/inno_entre/tech_challenge/tc/frontend/tc_hospital_frontend/src/components/student/editor/Editor.js"],"names":["React","useEffect","useState","setUserData","selectUserData","codeCompletionAsync","uploadStudentCodeAsync","fromRange","v4","uuidv4","useDispatch","useSelector","history","userData","Editor","close","taskData","selTxt","setSelTxt","tempCodes","setTempCodes","loadedTxt","setLoadedTxt","dispatch","bg","document","querySelector","content","style","cssText","marginTop","getElementsByClassName","innerHTML","txt","getElementById","height","scrollHeight","offsetHeight","hideCreateView","e","forced","contains","target","setTimeout","syncScroll","origin","scrollTop","currentTarget","scrollLeft","addCode","startOverlapCheck","filter","code","start","end","endOverlapCheck","length","alert","setSelectionRange","currentCodes","selector","select","window","getSelection","selectRange","getRangeAt","selectPos","getBoundingClientRect","codeInput","codeInputPos","tooltip","width","display","top","left","offsetWidth","xpath","val","toString","startOffset","endOffset","id","el","range","createRange","selectNodeContents","textNodes","getTextNodesIn","foundStart","charCount","endCharCount","i","textNode","setStart","setEnd","sel","removeAllRanges","addRange","node","nodeType","push","children","childNodes","len","apply","typingTimerEdit","editCode","type","clearTimeout","value","then","res","payload","matches","border","newArr","mergedObj","icdCode","icdCodeDesc","catch","err","console","log","removeTxt","splice","uploadStudentCode","nonFinishedCodes","index","reviewId","_id","location","reload","map"],"mappings":"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","sourcesContent":["import React, {useEffect, useState} from \"react\";\n\nimport '../../../styles/shared/editor/editor.css';\nimport '../../../styles/shared/fadein.css';\n\nimport {setUserData, selectUserData} from \"../../../slice/userSlice\";\nimport {codeCompletionAsync, uploadStudentCodeAsync} from \"../../../slice/reviewSlice\";\n\nimport {fromRange} from \"xpath-range\";\nimport {v4 as uuidv4} from \"uuid\";\n\nimport {useDispatch, useSelector} from \"react-redux\";\nimport {history} from \"../../../helpers/history\";\nimport {userData} from \"../../../services/user.service\";\n\nconst Editor = ({ close, taskData }) => {\n\n    const [selTxt, setSelTxt] = useState({})\n    const [tempCodes, setTempCodes] = useState([])\n    const [loadedTxt, setLoadedTxt] = useState(false)\n\n    const dispatch = useDispatch();\n\n    const userData = useSelector(selectUserData)\n\n    /**\n     * @function (01) get the dark background, the content wrapper and the inputs\n     *           (02) increase the dark background opacity\n     *           (03) fade up the content wrapper\n     *           =============\n     *           (04) insert the feature rich txt\n     *           (05) show the tooltip\n     *           (06) ensure that the code display has the same length as the overflow text\n     *           (07) ensure that the empty codes text is centered\n     */\n    useEffect(() => {\n        //01\n        let bg = document.querySelector('.menu_dark_bg'),\n            content = document.querySelector('.create_input_wrapper');\n        //02\n        bg.style.cssText = \"opacity: 100%\";\n        //03\n        content.style.marginTop = \"0\";\n        //04\n        document.getElementsByClassName('code_input')[0].innerHTML = taskData.txt;\n        //05\n        setLoadedTxt(true);\n        //06\n        document.getElementById('internal_code_display').style.height = document.getElementsByClassName('code_input')[0].scrollHeight+'px';\n        //07\n        document.getElementsByClassName('empty_editor')[0].style.height = document.getElementsByClassName('code_input')[0].offsetHeight+'px'\n    }, [])\n\n    /**\n     * @function (01) get the background and content\n     *           (02) return if user clicked on the content\n     *           (03) user clicked outside of content - hide\n     *           (04) after timeout set state again to hidden\n     */\n    const hideCreateView = (e, forced) => {\n        //01\n        let bg = document.querySelector('.menu_dark_bg'),\n            content = document.querySelector('.create_input_wrapper');\n        //02\n        if (!forced && content.contains(e.target)) return;\n        //03\n        bg.style.cssText = \"opacity: 0%\";\n        content.style.marginTop = \"150vh\";\n        //04\n        setTimeout(() => close(), 350)\n    };\n\n    /**\n     * @function (01) define the target by choosing the complementary of the scrolled div\n     *           (02) assign scroll toü and scroll left to the target based on the event scrolled position\n     */\n    const syncScroll = (e, origin) => {\n        //01\n        const target = origin === 'display' ? document.getElementsByClassName('code_input')[0] : document.getElementsByClassName('code_display')[0]\n        //02\n        target.scrollTop = e.currentTarget.scrollTop;\n        target.scrollLeft = e.currentTarget.scrollLeft;\n    }\n\n    //====================================================================\n\n    /**\n     * @function (01) check that there is no overlapping regarding the codes\n     *           (02) highlight the code\n     *           (03) push into data structure (updates the code overview on the right side)\n     */\n    const addCode = () => {\n        //01\n        let startOverlapCheck = tempCodes.filter(code => selTxt.start > code.start && selTxt.start < code.end)\n        let endOverlapCheck = tempCodes.filter(code => selTxt.end < code.end && selTxt.end > code.start)\n        if (startOverlapCheck.length > 0 || endOverlapCheck.length > 0) return alert('No overlaps possbile')\n        //02\n        setSelectionRange(selTxt.start, selTxt.end)\n        //highlight(\"yellow\");\n        //03\n        setTempCodes(currentCodes => [...currentCodes, selTxt]);\n    }\n\n    /**\n     * @function (01) get all selects and positions\n     *           (02) if only cursor change takes place only hide the tooltip\n     *           (03) reposition tooltip\n     *           (04) set selected text state\n     */\n    const selector = (e) => {\n        //01\n        let select = window.getSelection(),\n            selectRange = select.getRangeAt(0),\n            selectPos = selectRange.getBoundingClientRect(),\n            codeInput = document.getElementsByClassName('code_input')[0],\n            codeInputPos = codeInput.getBoundingClientRect(),\n            tooltip = document.getElementById('tooltip_editor_wrapper');\n        //02\n        if (selectPos.width < 1) return tooltip.style.display = \"none\";\n        //03\n        tooltip.style.display = \"inline\";\n        tooltip.style.top = (selectPos.top - codeInputPos.top - tooltip.offsetHeight - 10 + codeInput.scrollTop)+'px';\n        tooltip.style.left = (selectPos.left - codeInputPos.left + selectPos.width/2 - tooltip.offsetWidth / 2)+'px';\n        //04\n        let xpath = fromRange(selectRange, codeInput)\n\n        setSelTxt({...selTxt,  ...{\n                val: selectRange.toString(),\n                start: xpath.startOffset,\n                end: xpath.endOffset,\n                top: selectPos.top - codeInputPos.top + codeInput.scrollTop - 5,\n                id: uuidv4()\n            },\n        })\n    }\n\n    /**\n     * @function (01)\n     *           (02)\n     * @param start\n     * @param end\n     */\n    function setSelectionRange(start, end) {\n\n        let el = document.getElementsByClassName('code_input')[0];\n\n        var range = document.createRange();\n        range.selectNodeContents(el);\n        var textNodes = getTextNodesIn(el);\n        var foundStart = false;\n        var charCount = 0, endCharCount;\n\n        for (var i = 0, textNode; textNode = textNodes[i++]; ) {\n            endCharCount = charCount + textNode.length;\n            if (!foundStart && start >= charCount && (start < endCharCount || (start == endCharCount && i <= textNodes.length))) {\n                range.setStart(textNode, start - charCount);\n                foundStart = true;\n            }\n            if (foundStart && end <= endCharCount) {\n                range.setEnd(textNode, end - charCount);\n                break;\n            }\n            charCount = endCharCount;\n        }\n\n        var sel = window.getSelection();\n        sel.removeAllRanges();\n        sel.addRange(range);\n\n        //Helper functions\n\n        function getTextNodesIn(node) {\n            var textNodes = [];\n            if (node.nodeType === 3) {\n                textNodes.push(node);\n            } else {\n                var children = node.childNodes;\n                for (var i = 0, len = children.length; i < len; ++i) {\n                    textNodes.push.apply(textNodes, getTextNodesIn(children[i]));\n                }\n            }\n            return textNodes;\n        }\n    }\n\n    //====================================================================\n\n    /**\n     * @function (00) wait until typing ended and dispatch send to backend for code completion and wait - if more than one is found throw error\n     *           (01) duplicate the array\n     *           (02) find the array entry by index\n     *           (03) add code to this entry\n     *           (04) add the description\n     *           (05) indicate that this code is ok -> remove any border color\n     * @param e is the event\n     * @param i is the index of the array element which is\n     * @param type either id or desc of the code - required for the autocompletion\n     */\n    let typingTimerEdit;\n    const editCode = (e, i, type) => {\n        //00\n        clearTimeout(typingTimerEdit);\n        if (!e.target.value) return;\n        typingTimerEdit = setTimeout(() => {\n            dispatch(codeCompletionAsync({type: type, val: e.target.value}))\n                .then((res) => {\n                    if (res.payload.matches.length !== 1) {\n                        document.getElementsByClassName('ind_code_display')[i].style.border = \"1px solid red\";\n                        return document.getElementsByClassName('large_code_section')[i].value = 'Zu viele Ergebnisse - '+res.payload.matches.length\n                    }\n                    //01\n                    let newArr = [...tempCodes];\n                    //02\n                    let mergedObj = {...newArr[i], icdCode: e.target.value, icdCodeDesc: res.payload.matches[0][2]}\n                    newArr[i] = mergedObj;\n                    //03\n                    setTempCodes(newArr);\n                    //04\n                    document.getElementsByClassName('large_code_section')[i].value = res.payload.matches[0][2]\n                    //05\n                    document.getElementsByClassName('ind_code_display')[i].style.border = \"none\";\n                })\n                .catch((err) => {\n                    console.log(err)\n                });\n        }, 200);\n    }\n\n    /**\n     * @function (01) duplicate the array\n     *           (02) splice the array\n     *           (03) set the new temp codes\n     * @param i index of the highlight which is deleted\n     */\n    const removeTxt = (i) => {\n        let newArr = [...tempCodes];\n        //02\n        newArr.splice(i, 1);\n        //03\n        setTempCodes(newArr);\n    }\n\n    // ====================================================================\n\n    /**\n     * @function (01) check if all temp codes were assigned - if not proceed and let user assign icd 10 code\n     *           (02) upload codes to backend and perform server side comparison\n     *           (03) once finished jump to the analytics page where detailed information can be obtained\n     */\n    const uploadStudentCode = () => {\n        //01\n        const nonFinishedCodes = tempCodes.filter((code, index) => !code.icdCode || code.icdCode === \"\")\n        if (nonFinishedCodes.length > 0) return alert('not all codes were assigned');\n        //02\n        dispatch(uploadStudentCodeAsync({tempCodes, ...{reviewId: taskData._id}}))\n            .then((res) => {\n                //03\n                history.push(\"/student/analytics/\");\n                window.location.reload();\n            })\n            .catch((err) => {\n                console.log('err', err)\n            })\n\n    }\n\n    //====================================================================\n\n    return (\n        <div className=\"menu_dark_bg\" onClick={hideCreateView}>\n            <div className=\"create_input_wrapper enlarged_create_input_wrapper\">\n                <div className=\"create_input_hide\" onClick={(e) => {hideCreateView(e, true)}}>X</div>\n                <div className=\"code_input enlarged_code_input\" onMouseUp={selector} onScroll={(e) => syncScroll(e, 'input')}>\n\n                    {loadedTxt && <div id=\"tooltip_editor_wrapper\">\n                        <div className=\"tooltip_btn\" onClick={addCode}>Code hinzufügen</div>\n                    </div>}\n                </div>\n                <div className=\"code_display enlarged_code_display\" onScroll={(e) => syncScroll(e, 'display')}>\n                    <div id=\"internal_code_display\">\n                    {\n                        tempCodes.length > 0 ? (\n                            tempCodes.map((code, i) => {\n                                return <div className=\"ind_code_display\" id={code.id} style={{top:code.top+'px'}} key={i}>\n                                    <input placeholder=\"Code ID\" className=\"small_code_section\" onChange={(e) => editCode(e, i, 'id')}/>\n                                    <input placeholder=\"Code Desc\" className=\"large_code_section\" readOnly/>\n                                    <div className=\"remove_code_btn\" onClick={() => removeTxt(i)}>X</div>\n                                </div>;\n                            })\n                        ) : (\n                            <div className=\"empty_editor\">Vergebe Codes</div>\n                            )\n                    }\n                    </div>\n                    { tempCodes.length > 0 && <div className=\"student_compare_btn\" onClick={() => uploadStudentCode()}>Codes hochladen und vergleichen</div> }\n                </div>\n            </div>\n        </div>\n    );\n};\n\nexport default Editor;\n"]},"metadata":{},"sourceType":"module"}